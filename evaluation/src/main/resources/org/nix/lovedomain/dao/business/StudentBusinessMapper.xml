<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.nix.lovedomain.dao.business.StudentBusinessMapper">

    <!--学生的详细信息映射-->
    <resultMap id="studentVoMap" type="org.nix.lovedomain.service.vo.StudentVo">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="studentId" column="studentId" jdbcType="VARCHAR"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="phone" column="phone" jdbcType="VARCHAR"/>
        <result property="imageUrl" column="imageUrl" jdbcType="VARCHAR"/>
        <association property="classzz" column="classId"
                     javaType="org.nix.lovedomain.service.vo.ClassVo"
                     select="selectClassById">

        </association>
    </resultMap>

    <!--课堂的map映射信息-->
    <resultMap id="classVoMap" type="org.nix.lovedomain.service.vo.ClassVo">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="classId" column="classId" jdbcType="INTEGER"/>
        <association property="teacher" column="teacherId"
                     javaType="org.nix.lovedomain.service.vo.TeacherVo" select="selectTeacherById"/>

        <association property="profession" column="professionId"
                     javaType="org.nix.lovedomain.service.vo.ProfessionVo" select="selectProfessionById"/>
    </resultMap>

    <!--专业的详细信息map-->
    <resultMap id="professionVoMap" type="org.nix.lovedomain.service.vo.ProfessionVo">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="coding" column="coding" jdbcType="VARCHAR"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <association property="facultyVo" column="facultyId"
                     javaType="org.nix.lovedomain.service.vo.FacultyVo"
                     select="selectFacultyById"/>
        <association property="teacher" column="departmentId"
                     javaType="org.nix.lovedomain.service.vo.TeacherVo" select="selectTeacherById"/>
    </resultMap>

    <!--学院详细信息的查询-->
    <resultMap id="facultyVoMap" type="org.nix.lovedomain.service.vo.FacultyVo">
        <id property="id" column="id" jdbcType="INTEGER"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="coding" column="coding" jdbcType="VARCHAR"/>
        <association property="dean" column="dean"
                     javaType="org.nix.lovedomain.service.vo.TeacherVo" select="selectTeacherById"/>
    </resultMap>


    <!--查询课程信息，通过id-->
    <select id="selectClassById" parameterType="java.lang.Integer"
            resultMap="classVoMap">
        select * from `class` where id=#{id}
    </select>

    <!--查询老师信息，通过id-->
    <select id="selectTeacherById" parameterType="java.lang.Integer"
            resultType="org.nix.lovedomain.service.vo.TeacherVo">
        select * from `teacher` where id=#{id}
    </select>

    <!--查询专业信息通过id-->
    <select id="selectProfessionById" parameterType="java.lang.Integer"
            resultMap="professionVoMap">
        select * from `profession` where id=#{id}
    </select>

    <!--查询学院信息通过id-->
    <select id="selectFacultyById" parameterType="java.lang.Integer"
            resultMap="facultyVoMap">
        select * from `faculty` where id=#{id}
    </select>

    <!--发现学生的原始信息，分页查询-->
    <select id="findStudentPage"
            parameterType="org.nix.lovedomain.dao.business.page.StudentPageInquire"
            resultType="org.nix.lovedomain.dao.model.StudentModel">
        SELECT * FROM `student`
        <if test="pageInquire.quireField!=null and pageInquire.quireValue!=null">
            <bind name="blurrySelect" value="'%'+pageInquire.quireValue+'%'"></bind>
            WHERE
            ${pageInquire.quireField}
            <if test="pageInquire.blurry">
                LIKE #{blurrySelect}
            </if>
            <if test="!pageInquire.blurry">
                = #{pageInquire.quireValue}
            </if>
        </if>

        <if test="pageInquire.page!=null and  pageInquire.limit!=null">
            LIMIT #{pageInquire.startPoint},#{pageInquire.limit}
        </if>
    </select>

    <!--发现学生的数量 分页查询-->
    <select id="findStudentCount"
            parameterType="org.nix.lovedomain.dao.business.page.StudentPageInquire"
            resultType="java.lang.Long">
        SELECT COUNT(*) FROM `student`
        <if test="pageInquire.quireField!=null and pageInquire.quireValue!=null">
            <bind name="blurrySelect" value="'%'+pageInquire.quireValue+'%'"></bind>
            WHERE
            ${pageInquire.quireField}
            <if test="pageInquire.blurry">
                LIKE #{blurrySelect}
            </if>
            <if test="!pageInquire.blurry">
                = #{pageInquire.quireValue}
            </if>
        </if>
        <if test="pageInquire.page!=null and  pageInquire.limit!=null">
            LIMIT #{pageInquire.startPoint},#{pageInquire.limit}
        </if>
    </select>

    <!--业务需求，查询用户详细信息 分页查询-->
    <select id="findStudentVoPage"
            parameterType="org.nix.lovedomain.dao.business.page.StudentPageInquire"
            resultMap="studentVoMap">
        SELECT
        *
        FROM
        student
        LEFT JOIN class ON student.classId = class.id
        LEFT JOIN profession ON class.professionId = profession.id
        LEFT JOIN faculty ON profession.facultyId = faculty.id
        <if test="pageInquire.quireField!=null and pageInquire.quireValue!=null">
            <bind name="blurrySelect" value="'%'+pageInquire.quireValue+'%'"></bind>
            WHERE
            ${pageInquire.quireField}
            <if test="pageInquire.blurry">
                LIKE #{blurrySelect}
            </if>
            <if test="!pageInquire.blurry">
                = #{pageInquire.quireValue}
            </if>
        </if>
        <if test="pageInquire.page!=null and  pageInquire.limit!=null">
            LIMIT #{pageInquire.startPoint},#{pageInquire.limit}
        </if>
    </select>


    <select id="findStudentByTeacherIdAndCourseId" resultMap="studentVoMap">

      SELECT
        s.id,
        s.studentId,
        s.`name`,
        s.email,
        s.phone,
        s.imageUrl
        FROM
            student AS s
        LEFT JOIN student_course AS sc ON s.id = sc.studentId
        LEFT JOIN teacher_course AS tc ON tc.id = sc.courseId
        LEFT JOIN teacher AS t ON tc.teacherId = t.accountId
        WHERE tc.id = (SELECT id FROM teacher_course  WHERE teacher_course.courseId =  #{courseId}
        AND teacher_course.teacherId=#{teacherAccountId} 	ORDER BY
			teacher_course.createTime DESC
		LIMIT 1)

    </select>

    <select id="findStudentBySql" resultMap="studentVoMap">
        SELECT * FROM `student` WHERE 1=1
        <if test="sql!=null">
            ${sql}
        </if>
        <if test="page!=null and limit!=null">
            LIMIT #{page},#{limit};
        </if>
    </select>

    <select id="countStudentBySql" resultType="java.lang.Long">
        SELECT count(*) FROM `student` WHERE 1=1
        <if test="sql!=null">
            ${sql}
        </if>
    </select>

    <!--发现一个课程中所有的学生 -->
    <select id="getStudentByTeachCourse" resultMap="studentVoMap">
        SELECT
        student.studentId AS studentid,
        student.`name`,
        email,
        phone
          FROM
              student LEFT JOIN student_course ON student.id = student_course.studentId
            LEFT JOIN teacher_course ON student_course.courseId = teacher_course.id
          WHERE teacher_course.courseId = #{courseId,jdbcType=INTEGER}
          AND teacher_course.teacherId = #{teacherId,jdbcType=INTEGER}
  </select>

    <select id="findStudentModelByAccountIds" resultType="org.nix.lovedomain.dao.model.StudentModel">
        SELECT * FROM student WHERE 1=1
        <if test="accountIds!=null and accountIds.size()>0">
           AND accountId IN
            <foreach collection="accountIds" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="accountIds == null or accountIds.size()==0">
            AND accountId IN(-1)
        </if>
    </select>

</mapper>